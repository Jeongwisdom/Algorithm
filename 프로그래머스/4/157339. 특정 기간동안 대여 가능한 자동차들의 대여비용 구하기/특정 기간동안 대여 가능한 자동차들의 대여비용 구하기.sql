SELECT C.CAR_ID, C.CAR_TYPE, ROUND(C.DAILY_FEE * 30 * (100 - P.DISCOUNT_RATE) / 100) FEE FROM CAR_RENTAL_COMPANY_CAR C 
LEFT JOIN CAR_RENTAL_COMPANY_RENTAL_HISTORY H ON H.CAR_ID = C.CAR_ID 
JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN P ON P.CAR_TYPE = C.CAR_TYPE AND REGEXP_REPLACE(P.DURATION_TYPE, '[^0-9]+', '') = 30 
WHERE C.CAR_TYPE IN ('세단', 'SUV') AND C.CAR_ID NOT IN (SELECT CAR_ID FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY WHERE END_DATE BETWEEN '2022-11-01' AND '2022-11-30' OR START_DATE BETWEEN '2022-11-01' AND '2022-11-30' OR '2022-11-01' BETWEEN START_DATE AND END_DATE OR '2022-11-30' BETWEEN START_DATE AND END_DATE)
GROUP BY C.CAR_ID HAVING FEE BETWEEN 500000 AND 2000000 
ORDER BY FEE DESC, CAR_TYPE, CAR_ID;